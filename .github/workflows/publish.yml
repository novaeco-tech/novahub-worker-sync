name: Publish Worker Artifact (novahub-worker-sync)

on:
  push:
    branches:
      - main

permissions:
  contents: write # To create the GitHub Release
  
jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get Version (from src/VERSION.txt for example)
        id: get_version
        # (This is a simple example; you'd use a more robust versioning tool)
        run: echo "VERSION=$(cat src/VERSION.txt)" >> $GITHUB_ENV

      - name: Build & Package Worker
        run: |
          mkdir -p dist
          pip install -r src/requirements.txt -t./dist
          cp -r src/*.py./dist/
          # Package the built code
          tar -czf worker.tar.gz -C dist.

      - name: Create GitHub Pre-release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "novahub-worker-sync-v${{ env.VERSION }}"
          name: "NovaHub Worker Sync v${{ env.VERSION }}"
          files: "worker.tar.gz"
          prerelease: true # CRITICAL: Mark as "Pre-release"

      - name: Dispatch QA
        # This triggers the ecosystem-qa repo to test this new pre-release
        # The 'intra-novahub' test suite should test the 'novahub' enabler AND its workers
        run: |
          gh api repos/novaeco-tech/ecosystem-qa/dispatches \
            -f event_type='qa-run' \
            -f client_payload='{
                "tag": "novahub-worker-sync-v${{ env.VERSION }}", 
                "repo": "novahub-worker-sync", 
                "test_suite": "intra-novahub",
                "test_suite_path": "intra_enabler/test_novahub_and_worker.py"
              }'
        env:
          # A PAT with 'repo' scope is needed to trigger repository_dispatch
          GITHUB_TOKEN: ${{ secrets.DISPATCH_TOKEN }}